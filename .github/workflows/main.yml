# workflow11111
#======================================================================
# NOM DU WORKFLOW
# D√©finit le nom qui appara√Ætra dans l'interface GitHub Actions.
# ======================================================================
name: Java CI with Maven

# ======================================================================
# √âV√âNEMENTS D√âCLENCHEURS (TRIGGERS)
# D√©finit les √©v√©nements qui lanceront ce workflow.
# Il s'ex√©cutera lors d'un 'push' ou d'une 'pull_request' ciblant la branche 'main'.
# ======================================================================
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

# ======================================================================
# D√âFINITION DES JOBS
# Contient les t√¢ches √† ex√©cuter. Ici, un seul job nomm√© 'build'.
# ======================================================================
jobs:
  build:
    # ------------------------------------------------------------------
    # RUNNER
    # Sp√©cifie que le job doit s'ex√©cuter sur un runner auto-h√©berg√©.
    # ------------------------------------------------------------------
    runs-on: self-hosted

# ... (Partie on: et jobs: build: runs-on: self-hosted)

# üõë ATTENTION : SUPPRIMEZ INT√âGRALEMENT LE BLOC 'services:' DU WORKFLOW

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ------------------------------------------------------------------
      # NOUVELLE √âTAPE : CR√âER LE R√âSEAU (si n√©cessaire)
      # ------------------------------------------------------------------
      - name: Setup Docker Network
        run: docker network create spring-net || true
        # '|| true' √©vite l'√©chec si le r√©seau existe d√©j√† (pour les tests locaux/retry)

      # ------------------------------------------------------------------
      # NOUVELLE √âTAPE : D√âMARRAGE DU CONTENEUR MYSQL 
      # ------------------------------------------------------------------
      - name: Start MySQL Container
        run: |
          docker run -d \
            --name mysql-spring \
            --network spring-net \
            -p 3306:3306 \
            -e MYSQL_ALLOW_EMPTY_PASSWORD=yes \
            -e MYSQL_DATABASE=gestparc_db \
            -v ${{ github.workspace }}/init.sql:/docker-entrypoint-initdb.d/init.sql \
            -v mysql_data:/var/lib/mysql \
            mysql:8
        # Utilisez 'github.workspace' pour r√©f√©rencer le chemin absolu de 'init.sql'

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          
      - name: Wait for MySQL
        # Le ping doit cibler le conteneur, mais puisque le port 3306 est expos√©, l'attente locale fonctionne.
        run: |
          echo "Waiting for MySQL to start..."
          for i in {1..10}; do
            # Utilise l'acc√®s local car le port 3306 est expos√© (-p 3306:3306)
            if mysqladmin ping -h127.0.0.1 -uroot --silent; then
              echo "MySQL is up!"
              break
            fi
            echo "Waiting..."
            sleep 5
          done
      
      - name: Compile Code (mvn compile)
        run: mvn -B compile --file pom.xml

      - name: Run Unit and Integration Tests (mvn test)
        run: mvn -B test --file pom.xml
        env:
          # IMPORTANT : Utilisez maintenant le nom du conteneur dans l'URL si vous exposez uniquement le port
          # Si le conteneur est sur le m√™me r√©seau et vous n'utilisez PAS -p 3306:3306,
          # vous utiliseriez: jdbc:mysql://mysql-spring:3306/gestparc_db
          # Avec -p 3306:3306, l'acc√®s local est souvent le plus simple dans un runner.
          SPRING_DATASOURCE_URL: jdbc:mysql://127.0.0.1:3306/gestparc_db
          SPRING_DATASOURCE_USERNAME: root # Utilisateur root avec mot de passe vide
          SPRING_DATASOURCE_PASSWORD: '' # Mot de passe vide
          
      # ... (Reste des √©tapes de package et Docker) ...
        
      # ------------------------------------------------------------------
      # √âTAPES DE LIVRAISON (DOCKER BUILD & PUSH)
      # Ces √©tapes sont conditionnelles et s'ex√©cutent uniquement sur 'main'.
      # ------------------------------------------------------------------

      - name: Set up Docker Buildx
        if: github.ref == 'refs/heads/main'
        # Configure l'outil Docker Buildx pour une construction avanc√©e
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        if: github.ref == 'refs/heads/main'
        # Authentifie le runner pour pouvoir pousser l'image
        uses: docker/login-action@v2 
        with:
          username: ${{ secrets.DOCKER_USERNAME }} 
          password: ${{ secrets.DOCKER_PASSWORD }} 
          
      - name: Build Docker image
        if: github.ref == 'refs/heads/main'
        # Construit l'image Docker en utilisant le Dockerfile du d√©p√¥t
        run: docker build -t gestparc-app:local .

      - name: Tag and Push Docker image to Docker Hub
        if: github.ref == 'refs/heads/main'
        # Tag l'image avec le nom de d√©p√¥t complet et la pousse sur Docker Hub
        run: |
          # Tag : utilise le secret DOCKER_USERNAME et le tag 'latest'
          docker tag gestparc-app:local ${{ secrets.DOCKER_USERNAME }}/gestparc-app:latest
          # Push : envoie l'image taggu√©e au registre
          docker push ${{ secrets.DOCKER_USERNAME }}/gestparc-app:latest